name: CD

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop
      - main

jobs:
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.3.2
        with:
          ref: ${{ github.ref }}
          check-name: |
            Backend CI
            Frontend CI
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  build-and-push-docker-image-to-docker-hub:
    name: Build and Push Docker Image to Docker Hub
    needs: wait-for-ci
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Get .env file from secrets
        run: echo "${{ secrets.ENVIRONMENT_FILE }}" > .env

      - name: Make script executable
        run: chmod +x docker/build_and_push_image.sh

      - name: Run script
        run: ./build_and_push_image.sh ${{ secrets.DOCKER_HUB_USERNAME }}/findmypatient:${{ github.sha }} ${{ secrets.DOCKER_HUB_USERNAME }} ${{ secrets.DOCKER_HUB_PASSWORD }}
        working-directory: docker
